name: Create and Connect to AWS EC2
 
on:
  push:
    branches:
      - main
  workflow_dispatch:
 
jobs:
  create-and-connect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
 
      # - name: Install AWS CLI
      #   run: |
      #     sudo apt update
      #     sudo apt install awscli -y
 
      - name: Configure AWS Credentials
        run: |
          export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          export AWS_REGION=eu-north-1
 
      - name: Launch EC2 Instance
        run: |
          UBUNTU_AMI_ID=$(aws ec2 describe-images --owners 099720109477 \
              --filters "Name=name,Values=ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*" \
              --query 'Images | sort_by(@, &CreationDate)[-1].ImageId' --output text \
              --region eu-north-1)

          SUBNET_ID=$(aws ec2 describe-subnets --region eu-north-1 --query 'Subnets[0].SubnetId' --output text)
          SG_ID=$(aws ec2 describe-security-groups --region eu-north-1 --query 'SecurityGroups[0].GroupId' --output text)
          INSTANCE_ID=$(aws ec2 run-instances --image-id $UBUNTU_AMI_ID --count 1 --instance-type t2.micro --key-name praveenkeyAWS --security-groups $SG_ID --query "Instances[0].InstanceId" --output text)
          echo "Instance ID: $INSTANCE_ID"
 
      - name: Get EC2 Public IP
        run: |
          PUBLIC_IP=$(aws ec2 describe-instances --instance-ids $INSTANCE_ID --query "Reservations[0].Instances[0].PublicIpAddress" --output text)
          echo "EC2 Public IP: $PUBLIC_IP"
          echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
 
      - name: Set up SSH Connection
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $PUBLIC_IP >> ~/.ssh/known_hosts
 
      - name: Connect to EC2 and Run Command
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@$PUBLIC_IP "ls -l"
